<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
    <head>
        <meta charset="utf-8">
        
        <script>
            const isDarkMode = localStorage.getItem('is_darkmode_set') === 'true';
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
            }
        </script>
        
        <meta name="color-scheme" content="light dark">

        {# Detect Mastodon/Fediverse URL from config.extra.social with heuristics, then explicit extra.mastodon_url #}
        {% set_global mastodon_url = "" %}
        {% if config.extra.social is defined %}
            {# Pass 1: prefer entries explicitly labeled mastodon/fedi/fediverse (via icon or name) and valid /@ structure #}
            {% for s in config.extra.social %}
                {% if mastodon_url == "" and s.url %}
                    {% set icon = s.icon | default(value="") | lower %}
                    {% set name = s.name | default(value="") | lower %}
                    {% set icon_has_mastodon = icon | split(pat="mastodon") %}
                    {% set icon_has_fedi = icon | split(pat="fedi") %}
                    {% set name_has_mastodon = name | split(pat="mastodon") %}
                    {% set name_has_fedi = name | split(pat="fedi") %}
                    {% set name_has_fediverse = name | split(pat="fediverse") %}
                    {% if (icon_has_mastodon | length > 1) or (icon_has_fedi | length > 1) or (name_has_mastodon | length > 1) or (name_has_fedi | length > 1) or (name_has_fediverse | length > 1) %}
                        {% set parts = s.url | split(pat="/@") %}
                        {% if parts | length == 2 %}
                            {% set user_and_rest = parts | last %}
                            {% set user_parts = user_and_rest | split(pat="/") %}
                            {% if user_parts | length == 1 and user_and_rest | length > 0 %}
                                {% set_global mastodon_url = s.url %}
                            {% endif %}
                        {% endif %}
                    {% endif %}
                {% endif %}
            {% endfor %}
            {# Pass 2: fall back to any URL with proper /@username structure #}
            {% if mastodon_url == "" %}
                {% for s in config.extra.social %}
                    {% if mastodon_url == "" and s.url %}
                        {% set parts = s.url | split(pat="/@") %}
                        {% if parts | length == 2 %}
                            {% set user_and_rest = parts | last %}
                            {% set user_parts = user_and_rest | split(pat="/") %}
                            {% if user_parts | length == 1 and user_and_rest | length > 0 %}
                                {% set_global mastodon_url = s.url %}
                            {% endif %}
                        {% endif %}
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endif %}
        {% if config.extra.mastodon_url is defined and mastodon_url == "" and config.extra.mastodon_url %}
            {% set_global mastodon_url = config.extra.mastodon_url %}
        {% endif %}
        {% if mastodon_url %}
            <link rel="me" href="{{ mastodon_url }}">
        {% endif %}

        {% set gtag_id = config.extra.google_analytics_measurement_id %}
        {% if gtag_id %}
            <!-- Google tag (gtag.js) -->
            <script async src="https://www.googletagmanager.com/gtag/js?id={{ gtag_id }}"></script>
            <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag("js", new Date());

                gtag("config", "{{ gtag_id }}");
            </script>
        {% endif %}

        {% if config.generate_feeds %}
        <link rel="alternate"
              type="application/atom+xml"
              title="{{ config.title }} feed"
              href="{{ get_url(path='atom.xml') }}">
        {% endif %}

        <link rel="stylesheet" href="{{ get_url(path='css/style.css', cachebust=true) }}"/>
        <link rel="stylesheet" href="{{ get_url(path='css/overrides.css', cachebust=true) }}"/>
        <link rel="stylesheet" href="{{ get_url(path='line-awesome/css/line-awesome.min.css', cachebust=true) }}"/>
        <script src="{{ get_url(path='js/main.js', cachebust=true) }}" defer></script>
        {% block head_extend %}{% endblock %}
    </head>

    <body class="bg-white dark:bg-slate-900 transition ease-in-out">
        <section>
            {% block content %}{% endblock %}
        </section>
    </body>
</html>
