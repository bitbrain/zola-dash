{% extends "base.html" %}

{% import "macros.html" as macros %}

{% block head_extend %}
    <title>{{ page.title }} | {{ config.title }}</title>
    {# Open Graph / Twitter Cards #}
    {% set og_title = page.title %}
    {% set og_desc = page.summary | default(value=page.description) | default(value=config.description) %}
    {% set og_url = page.permalink %}
    {% set_global og_image = "" %}
    {% if page.extra is defined and page.extra.og_image is defined and page.extra.og_image %}
        {% set_global og_image = page.extra.og_image %}
    {% elif page.extra is defined and page.extra.image is defined and page.extra.image %}
        {% set_global og_image = page.extra.image %}
    {% elif config.extra is defined and config.extra.og_image is defined and config.extra.og_image %}
        {% set_global og_image = config.extra.og_image %}
    {% elif config.extra is defined and config.extra.homepage_img_url is defined and config.extra.homepage_img_url %}
        {% set_global og_image = config.extra.homepage_img_url %}
    {% endif %}
    {% if og_image != "" %}
        {% set parts = og_image | split(pat="://") %}
        {% if parts | length > 1 %}
            {% set og_image_abs = og_image %}
        {% else %}
            {% set og_image_abs = get_url(path=og_image) %}
        {% endif %}
    {% endif %}
    <meta property="og:type" content="article">
    <meta property="og:title" content="{{ og_title }}">
    {% if og_desc %}<meta property="og:description" content="{{ og_desc | striptags | trim }}">{% endif %}
    <meta property="og:url" content="{{ og_url }}">
    <meta property="og:site_name" content="{{ config.title }}">
    {% if og_image_abs %}<meta property="og:image" content="{{ og_image_abs }}">{% endif %}
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ og_title }}">
    {% if og_desc %}<meta name="twitter:description" content="{{ og_desc | striptags | trim }}">{% endif %}
    {% if og_image_abs %}<meta name="twitter:image" content="{{ og_image_abs }}">{% endif %}
    {# fediverse:creator meta for Mastodon if configured #}
    {% set_global mastodon_url = "" %}
    {% if config.extra.social is defined %}
        {# Pass 1: prefer entries explicitly labeled mastodon/fedi/fediverse (via icon or name) and valid /@ structure #}
        {% for s in config.extra.social %}
            {% if mastodon_url == "" and s.url %}
                {% set icon = s.icon | default(value="") | lower %}
                {% set name = s.name | default(value="") | lower %}
                {% set icon_has_mastodon = icon | split(pat="mastodon") %}
                {% set icon_has_fedi = icon | split(pat="fedi") %}
                {% set name_has_mastodon = name | split(pat="mastodon") %}
                {% set name_has_fedi = name | split(pat="fedi") %}
                {% set name_has_fediverse = name | split(pat="fediverse") %}
                {% if (icon_has_mastodon | length > 1) or (icon_has_fedi | length > 1) or (name_has_mastodon | length > 1) or (name_has_fedi | length > 1) or (name_has_fediverse | length > 1) %}
                    {% set parts = s.url | split(pat="/@") %}
                    {% if parts | length == 2 %}
                        {% set user_and_rest = parts | last %}
                        {% set user_parts = user_and_rest | split(pat="/") %}
                        {% if user_parts | length == 1 and user_and_rest | length > 0 %}
                            {% set_global mastodon_url = s.url %}
                        {% endif %}
                    {% endif %}
                {% endif %}
            {% endif %}
        {% endfor %}
        {# Pass 2: fall back to any URL with proper /@username structure #}
        {% if mastodon_url == "" %}
            {% for s in config.extra.social %}
                {% if mastodon_url == "" and s.url %}
                    {% set parts = s.url | split(pat="/@") %}
                    {% if parts | length == 2 %}
                        {% set user_and_rest = parts | last %}
                        {% set user_parts = user_and_rest | split(pat="/") %}
                        {% if user_parts | length == 1 and user_and_rest | length > 0 %}
                            {% set_global mastodon_url = s.url %}
                        {% endif %}
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endif %}
    {% if config.extra.mastodon_url is defined and mastodon_url == "" and config.extra.mastodon_url %}
        {% set_global mastodon_url = config.extra.mastodon_url %}
    {% endif %}
    {% if mastodon_url %}
        {% set mu = mastodon_url | replace(from="https://", to="") | replace(from="http://", to="") %}
        {% if mu | ends_with(suffix="/") %}
            {% set mu = mu | slice(end=(mu | length - 1)) %}
        {% endif %}
        {% set parts = mu | split(pat="/@") %}
        {% if parts | length == 2 %}
            {% set instance = parts | first %}
            {% set handle = parts | last %}
            <meta name="fediverse:creator" content="@{{ handle }}@{{ instance }}">
        {% endif %}
    {% endif %}
{% endblock head_extend %}

{% block content %}
    {{ macros::header(components=page.components, is_page=true) }}
    <div class="container mb-16">
        <div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl lg:text-base">
            {{ page.date | date(format="%Y-%m-%d") }}
        </div>
        <h1 class="w-full mt-4 mb-8 font-serif text-8xl lg:text-4xl text-slate-900 dark:text-slate-300">
            {{ page.title }}
        </h1>
        <div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div>
        <div class="prose-boring">
            {{ page.content | safe }}
        </div>
    </div>
{% endblock content %}
